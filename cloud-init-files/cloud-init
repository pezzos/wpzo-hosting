#cloud-config
cloud_final_modules:
- [users-groups,always]
users:
  - name: pezzos
    groups: [ adm, wheel, systemd-journal ]
    sudo: [ "ALL=(ALL) NOPASSWD:ALL" ]
    shell: /bin/bash
    homedir: /pezzos
    ssh-authorized-keys: 
    - AAAAB3NzaC1yc2EAAAADAQABAAABAQDQ3RDWQaLv5Trg+aO9LQWWTl+q+JemltruvjYkux22UujqJp0S/RxhR4y6g/a5IkcFQKpwGJe91TdbvRuM5cVMdLPwPw2e11YNHbrY79gtOs1mQ87imAKKlcQaDzsQQt7A3vgG8ug0MNT+iMj8CkullZymP/UJGDTAY2ZzcBRbIWVznjRmj0i36Js78ropZ3qiHynMNEthrA+adXqu1uYy3AReXxVP59hDERxmpK3OwKi0slOEWdOeLlfBKJcXgiXu1ELcMhfMPmh3m42NQDaXSSXXyGP74zCzjqysYHDRMw4bZn0kwBb22cBK9EHHL8z8zYr8D+cO2PDR61Mucnpb wpzo
package_update: true
package_upgrade: true
timezone: Europe/Paris
packages:
- nfs-utils


# Note, that the list has to be proper yaml, so you have to quote
# any characters yaml would eat (':' can be problematic)
runcmd:
#  - [ sh, -xc, "echo $(date) ': hello world!'" ]
  - amazon-linux-extras install -y epel vim
  - yum update -y
  - timedatectl set-timezone Europe/Paris
  - yum install -y fail2ban git ufw amazon-efs-utils
  - useradd -m pezzos -d /pezzos -s /bin/bash -G adm,wheel,systemd-journal
  - mkdir /pezzos/servers /pezzos/work /pezzos/bin /pezzos/scripts /pezzos/.ssh
  - cp /home/ec2-user/.ssh/authorized_keys /pezzos/.ssh/
  - chown -R pezzos:pezzos /pezzos
  - chmod 600 /pezzos/.ssh/*
  - chmod 700 /pezzos/.ssh/
  - echo "pezzos ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/90-cloud-init-users



  - sed -i -e '/^[#]*PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's|[#]*PasswordAuthentication yes|PasswordAuthentication no|g' /etc/ssh/sshd_config
  - restart ssh

  - userdel ec2-user
  - sed -i 's/^.*ec2-user.*$//g' /etc/sudoers.d/90-cloud-init-users

ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp
ufw allow 3306/tcp
ufw allow 2049/tcp
ufw enable
amazon-linux-extras install -y mariadb10.5

# Make sure that NOBODY can access the server without a password
mysql -e "UPDATE mysql.user SET Password = PASSWORD('<CHANGE_ME>') WHERE User = 'root'"
# Kill the anonymous users
mysql -e "DROP USER ''@'localhost'"
# Because our hostname varies we'll use some Bash magic here.
mysql -e "DROP USER ''@'$(hostname)'"
# Delete root user
mysql -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
# Kill off the demo database
mysql -e "DROP DATABASE test"
# Make our changes take effect
mysql -e "FLUSH PRIVILEGES"
# Any subsequent tries to run queries this way will get access denied because lack of usr/pwd param


#cloud-config
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install


# Add the database if MYSQL_USER_DB is set.
if [ ! -z "$MYSQL_USER_DB" ]; then
	echo "=> Creating $MYSQL_USER_DB."
	mysql -u'root' -p"$MYSQL_ROOT_PASS" -e "CREATE DATABASE IF NOT EXISTS \`$MYSQL_USER_DB\`;"
fi

# Add the MYSQL_USER_DB user if it exists and the user vars are set.
if [ ! -z "$MYSQL_USER_NAME" -a ! -z "$MYSQL_USER_PASS" -a ! -z "$MYSQL_USER_DB" ]; then
	echo "=> Creating $MYSQL_USER_NAME and granting privileges on $MYSQL_USER_DB."
	echo 'Creating user.'
	mysql -u'root' -p"$MYSQL_ROOT_PASS" -e "CREATE USER '$MYSQL_USER_NAME'@'%' IDENTIFIED BY '$MYSQL_USER_PASS';"
	echo 'Created user.'
	echo 'Granting user.'
	mysql -u'root' -p"$MYSQL_ROOT_PASS" -e "GRANT ALL PRIVILEGES ON \`$MYSQL_USER_DB\`.* TO '$MYSQL_USER_NAME'@'%' WITH GRANT OPTION;"
	echo 'Granted user.'
fi


#cloud-config
runcmd:
  - yum update -y
  - yum install -y amazon-efs-utils
  - echo "${EFS_DNS}:/ ${EFS_MOUNT_POINT} nfs nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 0 0" >> /etc/fstab
  - echo "172.31.4.169:/69pixl/servers/69p-poubelle-1/conf/files /home/ec2-user/files/  nfs4   defaults,noatime  1   1" >> /etc/fstab
  - echo "fs-50c7c7e1:/ /var/lib/mysql/test efs _netdev,noresvport,tls,iam 0 0" >> /etc/fstab
  - mount -a 

mount -t efs -o tls,accesspoint=fsap-06c05601b94fec5d8 fs-50c7c7e1:/ efs
nfsvers=4.1 â€“ used when mounting on EC2 Linux instances
rsize=1048576
wsize=1048576
hard
timeo=600
retrans=2
noresvport

EFS_FILE_SYSTEM_ID="fs-XXXXXXXX"
EFS_MOUNT_POINT="/mnt/efs"

tc2-nas01:/vol/vms_gu_mysql04_dbStorage /mnt/storage nfs rw,hard,nointr,rsize=65536,wsize=65536,bg,vers=3,proto=tcp,noatime
tc2-nas01:/vol/vms_gu_mysql04_dbStorage/mysql.tmp /mnt/mysql.tmp nfs rw,hard,nointr,rsize=65536,wsize=65536,bg,vers=3,proto=tcp,noatime
tc2-nas01:/vol/vms_gu_mysql04_dbStorage/mysql.log /mnt/mysql.log nfs rw,hard,nointr,rsize=65536,wsize=65536,bg,vers=3,proto=tcp,noatime
tc2-nas01:/vol/vms_gu_mysql04_dbStorage/mysql /mnt/mysql nfs rw,hard,nointr,rsize=65536,wsize=65536,bg,vers=3,proto=tcp,noatime